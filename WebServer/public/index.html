<html>
    <head>
        <meta name="viewport" content="width=device-width, maximum-scale=1.0, user-scalable=yes">
        <style>
            body {
                font: 1rem;
                text-align: center;
            }
            button {
                font-size: 1rem;
            }
            .wrapper {
                margin: 10px;
                margin-bottom: 40px;
            }
            .hide {
                display: none;
            }
            #msg-received {
                max-height: 62vh;
                overflow-y: auto;
            }
        </style>
        <link rel="stylesheet" href="/bootstrap.min.css">
    </head>
    <body>
        <div class="container">
            <h1>Kafka Local Test</h1>
            <div class="wrapper">
                <p>Send a message using producer <span id="connection-status"></span></p>
                <div class="input-group mb-3">
                    <div class="input-group-prepend">
                        <button id="topic-name" class="btn btn-info dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"></button>
                        <div id="topic-list" class="dropdown-menu">
                        </div>
                    </div>
                    <input id="msg-input" type="text" class="form-control" disabled placeholder="Message input" aria-label="Message input" aria-describedby="basic-addon2">
                    <div class="input-group-append">
                        <button id="send-btn" class="btn btn-primary" type="button" onclick="sendMessage()">Send</button>
                    </div>
                </div>
                <input id="repeat-chkbox" onchange="toggleInterval(this)" type="checkbox">
                <label for="repeat-chkbox">Repeat indefinitely <span id="repeat-tooltip">(1000 ms)</span></label>
                <form id="repeat-interval-wrapper" class="hide">
                    <div class="form-group">
                        <label for="repeat-interval">Repeat interval (ms)</label>
                        <input type="range" class="form-control-range" id="repeat-interval" value="100" onchange="updateInterval(this)">
                    </div>
                </form>
            </div>
            <div class="wrapper">
                <p style="font-weight: bold;">Messages received by consumer:</p>
                <hr>
                <div id="msg-received"></div>
            </div>
        </div>
    </body>
    <script src="/jquery.js"></script>
    <script src="/bootstrap.bundle.min.js"></script>
    <script>
        const WS_URL = location.origin.replace(/^http/, 'ws');
        var msgInput = document.getElementById("msg-input");
        const ws = new WebSocket(WS_URL);
        ws.onopen = () => {
            console.log(`Connected to ${WS_URL}`);
            msgInput.removeAttribute("disabled");
            msgInput.focus();
            document.getElementById("connection-status").innerHTML = "(Connected âœ…)"
        }
        ws.onclose = () => {
            msgInput.setAttribute("disabled", "disabled")
            document.getElementById("connection-status").innerHTML = "(Disconnected)"
        }
        function changeTopic(e) {
            $("#topic-name").html(e.innerHTML)
            msgInput.focus();
        }
        msgInput.addEventListener("keyup", function(event) {
            if (event.keyCode === 13) {
                sendMessage();
            }
        });
        ws.onmessage = message => {
            // console.log(message)
            var data = JSON.parse(message.data)
            if (data.topics) {
                console.log(data)
                data.topics.forEach(topic => {
                    $("#topic-list").append(`<a class="dropdown-item" onclick="changeTopic(this)" href="#">${topic}</a>`)
                })
                $("#topic-name").html(data.topics[0])
            } else {
                var p = document.createElement("p");
                p.innerHTML = `<b>Topic</b>: ${data.topic}, <b>Value</b>: "${data.value}", <b>Timestamp</b>: ${data.timestamp}, <b>Process Delay</b>: ${data.processDelay}`
                document.getElementById("msg-received").prepend(p);    
            }
        }
        function toggleInterval(e) {
            if (e.checked) {
                document.getElementById("repeat-interval-wrapper").classList.remove("hide")
            } else {
                document.getElementById("repeat-interval-wrapper").classList.add("hide")
                document.getElementById("send-btn").removeAttribute("disabled")
            }
        }
        function updateInterval(e) {
            document.getElementById("repeat-tooltip").innerHTML = `(${e.value*10} ms)`
        }
        function sendMessage(check, index) {
            msgInput.value = msgInput.value.trim()
            var val =  {
                topic: $("#topic-name").html(),
                message: msgInput.value
            };
            if (val.message) {
                var repeatMsg = document.getElementById("repeat-chkbox");
                if (check && !repeatMsg.checked) {
                    return;
                }
                if (repeatMsg.checked) {
                    document.getElementById("send-btn").setAttribute("disabled", "disabled")
                    if (index) {
                        index++;
                    } else {
                        index = 1;
                    }
                    setTimeout(() => {
                        sendMessage(true, index);
                    }, document.getElementById("repeat-interval").value * 10)
                    val.message += ` (${index})`
                    ws.send(JSON.stringify(val));
                } else {
                    msgInput.value = "";
                    ws.send(JSON.stringify(val));
                }
            }
        }
    </script>
</html>
